---
phase: 01-project-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - package.json
  - lib/pdf-config.ts
  - public/pdf.worker.min.mjs
  - components/pdf/PDFViewer.tsx
  - app/page.tsx
autonomous: true

must_haves:
  truths:
    - "PDF.js library loads without errors in browser"
    - "PDF.js worker initializes successfully in local environment"
    - "PDF.js worker initializes successfully in Vercel production environment"
    - "Application is accessible via public Vercel URL"
  artifacts:
    - path: "lib/pdf-config.ts"
      provides: "PDF.js worker initialization and configuration"
      exports: ["initPDFWorker", "loadPDFFromFile"]
      min_lines: 25
    - path: "public/pdf.worker.min.mjs"
      provides: "PDF.js worker file for client-side PDF processing"
      contains: "Mozilla"
    - path: "components/pdf/PDFViewer.tsx"
      provides: "Client component demonstrating PDF.js integration"
      contains: "use client"
    - path: "package.json"
      provides: "PDF.js dependency"
      contains: "pdfjs-dist"
  key_links:
    - from: "lib/pdf-config.ts"
      to: "/pdf.worker.min.mjs"
      via: "GlobalWorkerOptions.workerSrc assignment"
      pattern: "workerSrc.*=.*['\"]\/pdf\\.worker"
    - from: "components/pdf/PDFViewer.tsx"
      to: "lib/pdf-config.ts"
      via: "initPDFWorker function call"
      pattern: "import.*initPDFWorker.*from.*pdf-config"
    - from: "package.json pdfjs-dist version"
      to: "public/pdf.worker.min.mjs version"
      via: "version matching requirement"
      pattern: "pdfjs-dist.*5\\.4\\.530"
---

<objective>
Integrate PDF.js with correct worker configuration for production environment and deploy to Vercel to validate client-side PDF processing works in production.

Purpose: Establish PDF processing foundation that cannot be retrofitted later - worker architecture must be correct from day one to avoid major refactoring. Early Vercel deployment validates production configuration.

Output: Application deployed to Vercel with working PDF.js integration, demonstrated by successfully loading a test PDF without worker errors.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/01-project-foundation/01-RESEARCH.md
@.planning/phases/01-project-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Install PDF.js and configure worker for production</name>
  <files>
    package.json
    lib/pdf-config.ts
    public/pdf.worker.min.mjs
  </files>
  <action>
Install PDF.js library:
```bash
npm install pdfjs-dist@5.4.530
```

Copy PDF.js worker file from node_modules to public folder:
```bash
cp node_modules/pdfjs-dist/build/pdf.worker.min.mjs public/
```

Add postinstall script to package.json to automate worker copy on future installs:
```json
{
  "scripts": {
    "postinstall": "cp node_modules/pdfjs-dist/build/pdf.worker.min.mjs public/"
  }
}
```

Create `lib/pdf-config.ts` with worker initialization:
```typescript
import * as pdfjsLib from 'pdfjs-dist'
import type { PDFDocumentProxy } from 'pdfjs-dist'

/**
 * Initialize PDF.js worker configuration
 * MUST be called before any PDF operations
 * Call this in a useEffect or during component initialization
 */
export function initPDFWorker() {
  if (typeof window === 'undefined') {
    return // Server-side, skip
  }

  // Point to worker file in public folder (served from root URL path)
  pdfjsLib.GlobalWorkerOptions.workerSrc = '/pdf.worker.min.mjs'
}

/**
 * Load PDF from File object
 * Returns PDF document proxy
 */
export async function loadPDFFromFile(file: File): Promise<PDFDocumentProxy> {
  const arrayBuffer = await file.arrayBuffer()
  const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer })
  return loadingTask.promise
}
```

**Critical: Worker file version MUST match pdfjs-dist package version exactly (5.4.530). Version mismatch causes runtime errors.**

Why public folder: PDF.js worker must NOT be processed by Turbopack/Webpack bundler. Public folder serves files statically from root URL path.
  </action>
  <verify>
Verify files exist:
- `public/pdf.worker.min.mjs` (should be ~1.7MB)
- `lib/pdf-config.ts` (contains initPDFWorker and loadPDFFromFile functions)

Check package.json:
- Contains `"pdfjs-dist": "5.4.530"` in dependencies
- Contains postinstall script with cp command

Run `npm run build` to ensure TypeScript compilation succeeds with PDF.js types.
  </verify>
  <done>
PDF.js library is installed, worker file is copied to public folder with automated postinstall script, and TypeScript configuration module exists with proper worker path setup.
  </done>
</task>

<task type="auto">
  <name>Create test PDF viewer component</name>
  <files>
    components/pdf/PDFViewer.tsx
    app/page.tsx
  </files>
  <action>
Create `components/pdf/PDFViewer.tsx` as client component demonstrating PDF.js integration:

```typescript
'use client'

import { useState, useEffect } from 'react'
import { initPDFWorker, loadPDFFromFile } from '@/lib/pdf-config'
import type { PDFDocumentProxy } from 'pdfjs-dist'
import { Card } from '@/components/ui/card'

interface PDFViewerProps {
  file: File | null
}

export default function PDFViewer({ file }: PDFViewerProps) {
  const [pdf, setPdf] = useState<PDFDocumentProxy | null>(null)
  const [error, setError] = useState<string | null>(null)
  const [loading, setLoading] = useState(false)

  // Initialize worker once on mount
  useEffect(() => {
    initPDFWorker()
  }, [])

  // Load PDF when file changes
  useEffect(() => {
    if (!file) {
      setPdf(null)
      return
    }

    setLoading(true)
    setError(null)

    loadPDFFromFile(file)
      .then((loadedPdf) => {
        setPdf(loadedPdf)
        setLoading(false)
      })
      .catch((err) => {
        setError(err.message)
        setLoading(false)
      })
  }, [file])

  if (!file) {
    return null
  }

  if (loading) {
    return <Card className="p-6">Loading PDF...</Card>
  }

  if (error) {
    return <Card className="p-6 border-red-500">Error loading PDF: {error}</Card>
  }

  if (pdf) {
    return (
      <Card className="p-6">
        <p className="text-lg font-semibold">PDF loaded successfully</p>
        <p className="text-sm text-muted-foreground mt-2">
          Pages: {pdf.numPages}
        </p>
      </Card>
    )
  }

  return null
}
```

Update `app/page.tsx` to add file input and PDF viewer:
- Keep existing Card with heading and Upload PDF button
- Add hidden file input with type="file" accept="application/pdf"
- Connect button onClick to trigger file input click
- Add state for selected file
- Add PDFViewer component below existing UI
- Keep 'use client' directive at top

The goal is to enable testing PDF.js worker initialization by selecting a PDF file and seeing "PDF loaded successfully" with page count.
  </action>
  <verify>
Run `npm run dev` and access http://localhost:3000.

Test PDF upload:
1. Click "Upload PDF" button
2. Select any PDF file from your system
3. Verify "PDF loaded successfully" appears with page count
4. Check browser console - should show no errors about worker initialization
5. Try a multi-page PDF - page count should be accurate

If errors occur, check:
- Console for "Worker" errors → indicates worker path misconfiguration
- Console for version mismatch → indicates worker file version doesn't match pdfjs-dist
- Network tab shows `/pdf.worker.min.mjs` loads successfully (status 200)
  </verify>
  <done>
PDFViewer component successfully loads PDF files, displays page count, initializes PDF.js worker without errors, and demonstrates working client-side PDF processing foundation.
  </done>
</task>

<task type="auto">
  <name>Deploy to Vercel and validate production worker configuration</name>
  <files>
    (no file modifications - deployment task)
  </files>
  <action>
Install Vercel CLI globally (if not already installed):
```bash
npm install -g vercel
```

Login to Vercel (opens browser for authentication):
```bash
vercel login
```

Deploy to Vercel production (first deployment links project):
```bash
vercel --prod
```

Vercel will:
1. Detect Next.js framework automatically
2. Run build process (`npm run build`)
3. Deploy to production URL
4. Output deployment URL (e.g., https://rspv-xyz.vercel.app)

After deployment completes, test the production application:

1. Visit the Vercel URL in browser
2. Click "Upload PDF" and select a test PDF
3. Verify PDF loads successfully with page count
4. Check browser console for any worker errors
5. Test with 5-10MB PDF to validate larger files work

**Critical validation:** PDF.js worker MUST load without errors in production. Common failure modes:
- Worker file 404 → not included in Vercel build
- MIME type error → incorrect file serving configuration
- Version mismatch → worker file version doesn't match pdfjs-dist

If worker fails in production:
- Check Vercel build logs for errors
- Verify `public/pdf.worker.min.mjs` is included in deployment
- Try clearing Vercel cache and redeploying

Record the production URL for documentation.
  </action>
  <verify>
Production deployment verification:

1. Vercel deployment succeeds without build errors
2. Production URL is accessible (returns 200 status)
3. Application loads in browser at production URL
4. PDF upload works correctly in production
5. Browser console shows no worker errors in production
6. Network tab shows `/pdf.worker.min.mjs` loads with 200 status in production
7. PDF.js successfully initializes and displays page count in production

**Success criteria:** If a 10MB PDF loads successfully in production Vercel environment and displays accurate page count, the worker configuration is correct.

Document the production URL in summary.
  </verify>
  <done>
Application is deployed to Vercel production, publicly accessible, and PDF.js worker configuration is validated to work correctly in production environment, eliminating risk of worker issues in future phases.
  </done>
</task>

</tasks>

<verification>
**Overall Phase 1 Plan 02 Verification:**

1. PDF.js library installed: `npm list pdfjs-dist` shows version 5.4.530
2. Worker file exists in public folder: `ls public/pdf.worker.min.mjs` succeeds
3. Worker file size is ~1.7MB (not corrupted)
4. TypeScript types work: `npm run build` succeeds with no PDF.js type errors
5. Local PDF upload works: Select PDF → see page count without console errors
6. Vercel deployment succeeds: Build completes without errors
7. Production URL accessible: Visit URL → application loads
8. Production PDF upload works: Upload PDF in production → see page count
9. No worker errors in production browser console
10. Network tab shows worker file loads successfully in both local and production

**Files that must exist:**
- package.json (with pdfjs-dist dependency and postinstall script)
- lib/pdf-config.ts (worker initialization)
- public/pdf.worker.min.mjs (worker file)
- components/pdf/PDFViewer.tsx (test component)

**Critical validation:** PDF.js worker MUST work in Vercel production. This cannot be fixed later without major refactoring.
</verification>

<success_criteria>
**Measurable completion criteria:**

1. ✓ PDF.js version 5.4.530 installed and listed in package.json
2. ✓ Worker file exists at `public/pdf.worker.min.mjs` (size ~1.7MB)
3. ✓ `lib/pdf-config.ts` exists with initPDFWorker and loadPDFFromFile functions
4. ✓ `components/pdf/PDFViewer.tsx` exists with 'use client' directive
5. ✓ Local test: Upload PDF → displays page count with no console errors
6. ✓ Vercel deployment URL is accessible and returns 200 status
7. ✓ Production test: Upload PDF at Vercel URL → displays page count with no console errors
8. ✓ Browser console in production shows no "Worker" or "version mismatch" errors
9. ✓ Network tab in production shows `/pdf.worker.min.mjs` loads with 200 status
10. ✓ Test with 10MB PDF in production succeeds

**Phase 1 complete when:** Application is deployed to Vercel, shadcn components render with Stone theme, and PDF.js worker functions correctly in production environment.
</success_criteria>

<output>
After completion, create `.planning/phases/01-project-foundation/01-02-SUMMARY.md` following the summary template with:
- Frontmatter including:
  - tech_stack.added (pdfjs-dist)
  - vercel_url (production deployment URL)
  - affects: ["02-core-rsvp-engine"] (PDF foundation enables RSVP engine)
- Files created (lib/pdf-config.ts, components/pdf/PDFViewer.tsx, public/pdf.worker.min.mjs)
- Patterns established (PDF.js worker configuration, client-side PDF processing)
- Decisions made (worker in public folder, version matching via postinstall)
- Critical validations (worker works in Vercel production)
- Next phase context (PDF infrastructure ready for RSVP engine integration)
</output>
