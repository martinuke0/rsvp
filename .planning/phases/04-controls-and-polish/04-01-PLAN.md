---
phase: 04-controls-and-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/page.tsx
  - components/reader/RSVPControls.tsx
autonomous: true

must_haves:
  truths:
    - "User can press Space to toggle play/pause without page scrolling"
    - "User can press Escape to return to navigation view"
    - "User can press R to restart current section from beginning"
    - "Keyboard shortcuts do not fire when typing in text input"
  artifacts:
    - path: "app/page.tsx"
      provides: "Global keyboard event handler with input field guards"
      contains: "handleKeyDown"
      min_lines: 150
    - path: "components/reader/RSVPControls.tsx"
      provides: "Restart button triggering section restart"
      exports: ["RSVPControls"]
      contains: "RotateCcw"
  key_links:
    - from: "app/page.tsx"
      to: "useReadingStore.setIsPlaying"
      via: "Space key handler"
      pattern: "case ' '.*setIsPlaying"
    - from: "app/page.tsx"
      to: "setView"
      via: "Escape key handler"
      pattern: "case 'Escape'.*setView"
    - from: "components/reader/RSVPControls.tsx"
      to: "useReadingStore.setCurrentWord"
      via: "handleRestart function"
      pattern: "setCurrentWord.*words\\[0\\]"
---

<objective>
Add keyboard shortcuts and restart functionality to complete reading controls - enabling hands-free reading control via Space/Escape/R keys and one-click section restart.

Purpose: Essential UX polish for speed reading - users need keyboard shortcuts for flow state maintenance and restart capability for comprehension review without losing section context.

Output: Fully keyboard-accessible RSVP reader with play/pause (Space), exit (Escape), restart (R), and restart button in controls UI.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-controls-and-polish/04-RESEARCH.md

# Current implementation
@app/page.tsx
@components/reader/RSVPControls.tsx
@store/reading-store.ts
@lib/rsvp/engine.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add global keyboard shortcut handler</name>
  <files>app/page.tsx</files>
  <action>
Add global keyboard event handler in Home component with useEffect:

1. Create handleKeyDown function:
   - Guard: Check if `e.target instanceof HTMLInputElement || e.target instanceof HTMLTextAreaElement` - if true, return early (do NOT trigger shortcuts while typing)
   - Space key: `e.preventDefault()` (prevent page scroll), toggle play/pause via `useReadingStore.getState().setIsPlaying(!isPlaying)`
   - Escape key: `e.preventDefault()`, check if view === 'reading', if true call `handleBackToNavigation()` (already exists in page.tsx)
   - 'r' or 'R' key: `e.preventDefault()`, call restart handler (create as `handleRestart`)

2. Create handleRestart function with useCallback:
   - Stop playback: `useReadingStore.getState().setIsPlaying(false)`
   - Get words array: `const words = useReadingStore.getState().words`
   - Reset to first word: if words.length > 0, call `useReadingStore.getState().setCurrentWord(words[0], 0)`

3. Add useEffect for keyboard listener:
   - `window.addEventListener('keydown', handleKeyDown)`
   - CRITICAL: Return cleanup function `() => window.removeEventListener('keydown', handleKeyDown)`
   - Dependencies: [view] (handler uses view state)

Implementation notes from research:
- Use `e.key` (not `e.keyCode` - deprecated)
- Input field guard is CRITICAL - prevents shortcuts while typing in Textarea
- `e.preventDefault()` prevents Space from scrolling page
- Cleanup function prevents memory leak from duplicate listeners
- Use getState() for one-time reads (no subscription needed)
  </action>
  <verify>
1. Build succeeds: `npm run build`
2. Test Space key:
   - Load text, press Space (should start playing)
   - Press Space again (should pause)
   - Page should NOT scroll
3. Test Escape key:
   - Load PDF, select section, press Escape (should return to navigation)
4. Test R key:
   - Load text, play to word 10, pause, press R (should reset to word 1)
5. Test input guard:
   - Focus textarea, type 'r' (should type letter, NOT restart)
   - Type space in textarea (should add space, NOT toggle play)
  </verify>
  <done>
- Space toggles play/pause without page scroll
- Escape returns to navigation when in reading view
- R restarts section from first word
- Shortcuts ignored when typing in input/textarea
- Build passes TypeScript compilation
  </done>
</task>

<task type="auto">
  <name>Task 2: Add restart button to controls UI</name>
  <files>components/reader/RSVPControls.tsx</files>
  <action>
Enhance RSVPControls component with visual restart button:

1. Import RotateCcw icon from lucide-react

2. Add handleRestart function (same logic as page.tsx):
   - Stop playback: `setIsPlaying(false)` (use existing hook subscription)
   - Get words: `const words = useReadingStore.getState().words`
   - Reset to first word: if words.length > 0, call `useReadingStore.getState().setCurrentWord(words[0], 0)`

3. Add restart button AFTER play/pause button:
```tsx
<Button
  onClick={handleRestart}
  variant="outline"
  size="sm"
  disabled={totalWords === 0}
>
  <RotateCcw className="mr-2 h-4 w-4" />
  Restart Section
</Button>
```

4. Add keyboard hint text below controls:
```tsx
{totalWords > 0 && (
  <div className="text-xs text-muted-foreground">
    Shortcuts: Space = Play/Pause, R = Restart, Esc = Back
  </div>
)}
```

Layout: Keep vertical flex-col with gap-4 for clean stacking.
  </action>
  <verify>
1. Build succeeds: `npm run build`
2. Visual verification:
   - Load text
   - Restart button appears below Play/Pause button
   - Restart button disabled when no text loaded
   - Restart button enabled when text loaded
3. Click restart button:
   - Playing stops
   - Current word resets to first word
   - Click Play again - reading restarts from beginning
4. Keyboard hint text visible below controls
  </verify>
  <done>
- Restart button visible in controls UI
- Button click resets to first word and stops playback
- Button disabled when totalWords === 0
- Keyboard shortcuts hint displayed
- Build passes TypeScript compilation
  </done>
</task>

</tasks>

<verification>
Run verification sequence:

1. **Keyboard shortcuts functional:**
```bash
npm run build && npm run dev
```
- Load sample text, press Space (starts playing)
- Press Space again (pauses)
- Press R (restarts to word 1)
- Load PDF with TOC, select section, press Escape (returns to navigation)

2. **Input field guard works:**
- Focus textarea for manual text input
- Type "restart test" including 'r' and spaces
- Text should appear in textarea, shortcuts should NOT fire

3. **Restart button works:**
- Load text, click Play, wait 5 seconds, click Restart
- Reading should reset to first word
- Current word display shows word 1 of N

4. **TypeScript compilation:**
```bash
npm run build
```
Should complete without errors.
</verification>

<success_criteria>
**Observable behaviors:**
- Space key toggles play/pause without page scroll
- Escape key returns to navigation from reading view
- R key restarts section from beginning
- Restart button resets reading to first word
- Keyboard shortcuts do not fire when typing in input/textarea
- Keyboard hints displayed in UI

**Technical correctness:**
- Event listener cleanup function prevents memory leak
- Input field guard uses instanceof checks
- preventDefault() stops browser default actions
- getState() used for one-time reads (no unnecessary subscriptions)

**Requirements fulfilled:**
- CTRL-03: User can restart current section from beginning ✓
- CTRL-04: User can control reading with keyboard shortcuts (Space, Escape, R) ✓
</success_criteria>

<output>
After completion, create `.planning/phases/04-controls-and-polish/04-01-SUMMARY.md` with:
- Performance metrics (duration, tasks completed)
- Files modified (app/page.tsx, components/reader/RSVPControls.tsx)
- Keyboard shortcuts implemented (Space, Escape, R)
- Input field guard verification
- Restart functionality verification
- Any deviations from plan
- Readiness for Plan 04-02 (position persistence)
</output>
