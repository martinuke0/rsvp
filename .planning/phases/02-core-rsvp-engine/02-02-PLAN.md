---
phase: 02-core-rsvp-engine
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - components/reader/RSVPDisplay.tsx
  - components/reader/RSVPControls.tsx
  - components/reader/SettingsPanel.tsx
  - app/page.tsx
autonomous: false

must_haves:
  truths:
    - "User sees words displayed at screen center with ORP highlighting"
    - "User can play/pause reading with visual state indication"
    - "User can adjust WPM (100-1000) with live slider value display"
    - "User can adjust word grouping (1-5) during reading"
    - "Display updates at 60fps without frame drops at high WPM"
  artifacts:
    - path: "components/reader/RSVPDisplay.tsx"
      provides: "RSVP word display with center letter highlighting"
      exports: ["RSVPDisplay"]
      min_lines: 60
      contains: "splitAtORP"
    - path: "components/reader/RSVPControls.tsx"
      provides: "Play/pause controls"
      exports: ["RSVPControls"]
      min_lines: 40
    - path: "components/reader/SettingsPanel.tsx"
      provides: "WPM and grouping sliders"
      exports: ["SettingsPanel"]
      exports_also: "shadcn Slider, Card components"
      min_lines: 80
    - path: "app/page.tsx"
      provides: "Integrated reading interface"
      contains: "RSVPDisplay"
      min_lines: 50
  key_links:
    - from: "components/reader/RSVPDisplay.tsx"
      to: "useReadingStore"
      via: "selective subscription"
      pattern: "useReadingStore\\(.*=>.*\\.currentWord\\)"
    - from: "components/reader/RSVPDisplay.tsx"
      to: "RSVPEngine"
      via: "useRef and useEffect"
      pattern: "useRef<RSVPEngine"
    - from: "components/reader/RSVPControls.tsx"
      to: "store actions"
      via: "setIsPlaying"
      pattern: "setIsPlaying"
    - from: "components/reader/SettingsPanel.tsx"
      to: "shadcn Slider"
      via: "import from ui/slider"
      pattern: "@/components/ui/slider"
---

<objective>
Create React components for RSVP display, controls, and settings using the core engine and stores from Plan 01.

Purpose: Provide the user-facing interface for speed reading with precise center letter highlighting, play/pause controls, and live WPM/grouping adjustments. Uses frontend-design skill for shadcn UI components as requested by user.

Output: Working RSVP reading experience integrated into home page with sample text.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md

Use frontend-design skill for UI component creation.
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-rsvp-engine/02-RESEARCH.md
@.planning/phases/01-project-foundation/01-01-SUMMARY.md
@.planning/phases/01-project-foundation/01-02-SUMMARY.md

# Plan 01 outputs (completed first)
@lib/rsvp/engine.ts
@lib/rsvp/orp-calculator.ts
@lib/rsvp/word-grouper.ts
@store/reading-store.ts
@store/settings-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install shadcn Slider component</name>
  <files>components/ui/slider.tsx</files>
  <action>
Install shadcn/ui Slider component for WPM and word grouping controls:

```bash
npx shadcn@latest add slider
```

This adds:
- components/ui/slider.tsx (Radix UI slider primitive with Stone theme styling)
- Necessary Radix dependencies if not already installed

Slider is essential for live WPM adjustment during reading (RSVP-05 requirement).
  </action>
  <verify>
```bash
ls components/ui/slider.tsx
npm run build
```
  </verify>
  <done>components/ui/slider.tsx exists, build passes</done>
</task>

<task type="auto">
  <name>Task 2: Create RSVPDisplay component</name>
  <files>components/reader/RSVPDisplay.tsx</files>
  <action>
Create the core RSVP display component with center letter highlighting using ORP calculation.

**Implementation requirements:**

**1. Use 'use client' directive** (PDF.js pattern from Phase 01-02)

**2. Selective Zustand subscriptions** (critical for performance):
```typescript
const currentWord = useReadingStore((state) => state.currentWord);
const isPlaying = useReadingStore((state) => state.isPlaying);
const currentIndex = useReadingStore((state) => state.currentIndex);
const wpm = useSettingsStore((state) => state.wpm);
```
Components re-render ONLY when subscribed values change.

**3. RSVPEngine in useRef** (persists across re-renders):
```typescript
const engineRef = useRef<RSVPEngine | null>(null);

useEffect(() => {
  engineRef.current = new RSVPEngine();
  return () => engineRef.current?.destroy();
}, []);
```

**4. Handle play/pause with useEffect**:
```typescript
useEffect(() => {
  const words = useReadingStore.getState().words;

  if (isPlaying && engineRef.current) {
    engineRef.current.start(
      words,
      wpm,
      currentIndex,
      (word, index) => {
        setCurrentWord(word, index);
      }
    );
  } else {
    engineRef.current?.pause();
  }
}, [isPlaying, wpm, currentIndex]);
```

**5. Split word at ORP for rendering**:
```typescript
const [before, center, after] = currentWord
  ? splitAtORP(currentWord)
  : ['', '', ''];
```

**6. Visual styling** (from RESEARCH.md):
```tsx
<div className="flex items-center justify-center min-h-[200px] bg-background">
  <div className="text-center font-mono text-4xl">
    {currentWord ? (
      <span>
        <span className="text-foreground/70">{before}</span>
        <span className={clsx(
          "text-red-500 font-bold",
          "relative",
          "after:content-[''] after:absolute after:inset-0",
          "after:bg-red-500/10 after:-z-10 after:scale-150"
        )}>
          {center}
        </span>
        <span className="text-foreground/70">{after}</span>
      </span>
    ) : (
      <span className="text-muted-foreground">
        Press play to start reading
      </span>
    )}
  </div>
</div>
```

**Key aspects:**
- Monospace font for consistent character spacing
- Dimmed prefix/suffix (70% opacity)
- Red center letter with bold and subtle background glow
- 200px min-height prevents layout shift
- Empty state message when no word loaded

Reference complete implementation from RESEARCH.md Pattern 3 (lines 681-764).

Create components/reader/ directory if needed.
  </action>
  <verify>
```bash
cat components/reader/RSVPDisplay.tsx | grep "splitAtORP"
cat components/reader/RSVPDisplay.tsx | grep "useReadingStore"
cat components/reader/RSVPDisplay.tsx | grep "RSVPEngine"
npm run build
```
  </verify>
  <done>components/reader/RSVPDisplay.tsx exists with ORP highlighting, selective subscriptions, RAF engine integration, build passes</done>
</task>

<task type="auto">
  <name>Task 3: Create RSVPControls component</name>
  <files>components/reader/RSVPControls.tsx</files>
  <action>
Create play/pause controls with visual state indication.

**Implementation:**

```typescript
'use client';

import { useReadingStore } from '@/store/reading-store';
import { Button } from '@/components/ui/button';
import { Play, Pause } from 'lucide-react';

export function RSVPControls() {
  const isPlaying = useReadingStore((state) => state.isPlaying);
  const setIsPlaying = useReadingStore((state) => state.setIsPlaying);
  const currentIndex = useReadingStore((state) => state.currentIndex);
  const totalWords = useReadingStore((state) => state.totalWords);

  const handleToggle = () => {
    setIsPlaying(!isPlaying);
  };

  const progress = totalWords > 0
    ? Math.round((currentIndex / totalWords) * 100)
    : 0;

  return (
    <div className="flex flex-col items-center gap-4">
      {/* Play/Pause Button */}
      <Button
        onClick={handleToggle}
        size="lg"
        className="min-w-[120px]"
        disabled={totalWords === 0}
      >
        {isPlaying ? (
          <>
            <Pause className="mr-2 h-5 w-5" />
            Pause
          </>
        ) : (
          <>
            <Play className="mr-2 h-5 w-5" />
            Play
          </>
        )}
      </Button>

      {/* Progress indicator */}
      {totalWords > 0 && (
        <div className="text-sm text-muted-foreground">
          Word {currentIndex + 1} of {totalWords} ({progress}%)
        </div>
      )}
    </div>
  );
}
```

**Key aspects:**
- Selective subscriptions (only isPlaying, currentIndex, totalWords)
- Button disabled when no text loaded
- Visual state with icon toggle (Play/Pause from lucide-react)
- Progress indicator shows position in text
- Uses shadcn Button from Phase 01-01

lucide-react already installed as shadcn dependency.

Create in components/reader/ directory.
  </action>
  <verify>
```bash
cat components/reader/RSVPControls.tsx | grep "useReadingStore"
cat components/reader/RSVPControls.tsx | grep "Play\|Pause"
npm run build
```
  </verify>
  <done>components/reader/RSVPControls.tsx exists with play/pause toggle, progress display, build passes</done>
</task>

<task type="auto">
  <name>Task 4: Create SettingsPanel component</name>
  <files>components/reader/SettingsPanel.tsx</files>
  <action>
Create settings panel with WPM and word grouping sliders using shadcn components.

**Implementation from RESEARCH.md Pattern 3 (lines 768-848):**

```typescript
'use client';

import { useSettingsStore } from '@/store/settings-store';
import { useDebounce } from 'use-debounce';
import { Label } from '@/components/ui/label';
import { Slider } from '@/components/ui/slider';
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from '@/components/ui/card';

export function SettingsPanel() {
  const wpm = useSettingsStore((state) => state.wpm);
  const wordsPerGroup = useSettingsStore((state) => state.wordsPerGroup);
  const setWPM = useSettingsStore((state) => state.setWPM);
  const setWordsPerGroup = useSettingsStore((state) => state.setWordsPerGroup);

  // Debounce WPM changes to prevent excessive store updates during drag
  const [debouncedWPM] = useDebounce(wpm, 100);

  return (
    <Card className="w-full max-w-md">
      <CardHeader>
        <CardTitle>Reading Settings</CardTitle>
        <CardDescription>
          Customize your reading experience
        </CardDescription>
      </CardHeader>
      <CardContent className="space-y-6">
        {/* WPM Control */}
        <div className="space-y-2">
          <div className="flex justify-between">
            <Label htmlFor="wpm-slider">Reading Speed</Label>
            <span className="text-sm text-muted-foreground">
              {wpm} WPM
            </span>
          </div>
          <Slider
            id="wpm-slider"
            min={100}
            max={1000}
            step={50}
            value={[wpm]}
            onValueChange={([value]) => setWPM(value)}
            className="w-full"
          />
          <p className="text-xs text-muted-foreground">
            Recommended: 250-400 WPM for comfortable reading
          </p>
        </div>

        {/* Word Grouping Control */}
        <div className="space-y-2">
          <div className="flex justify-between">
            <Label htmlFor="grouping-slider">Words Per Flash</Label>
            <span className="text-sm text-muted-foreground">
              {wordsPerGroup} {wordsPerGroup === 1 ? 'word' : 'words'}
            </span>
          </div>
          <Slider
            id="grouping-slider"
            min={1}
            max={5}
            step={1}
            value={[wordsPerGroup]}
            onValueChange={([value]) => setWordsPerGroup(value)}
            className="w-full"
          />
          <p className="text-xs text-muted-foreground">
            More words = faster reading, but requires practice
          </p>
        </div>
      </CardContent>
    </Card>
  );
}
```

**Key aspects:**
- WPM range: 100-1000 (RSVP-04 requirement)
- Word grouping: 1-5 words (RSVP-03 requirement)
- Live value display above each slider
- Guidance text for user expectations
- Card layout matches Phase 01-01 aesthetic
- useDebounce prevents excessive updates during drag

Need to install shadcn Label component if not already present:
```bash
npx shadcn@latest add label
```

Create in components/reader/ directory.
  </action>
  <verify>
```bash
ls components/ui/label.tsx
cat components/reader/SettingsPanel.tsx | grep "Slider"
cat components/reader/SettingsPanel.tsx | grep "useDebounce"
npm run build
```
  </verify>
  <done>components/reader/SettingsPanel.tsx exists with WPM and grouping sliders, debounced updates, build passes</done>
</task>

<task type="auto">
  <name>Task 5: Integrate components into home page</name>
  <files>app/page.tsx</files>
  <action>
Update home page to demonstrate RSVP reading with sample text.

**Implementation:**

```typescript
'use client';

import { useState, useEffect } from 'react';
import { RSVPDisplay } from '@/components/reader/RSVPDisplay';
import { RSVPControls } from '@/components/reader/RSVPControls';
import { SettingsPanel } from '@/components/reader/SettingsPanel';
import { useReadingStore } from '@/store/reading-store';
import { useSettingsStore } from '@/store/settings-store';
import { groupWords } from '@/lib/rsvp/word-grouper';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Textarea } from '@/components/ui/textarea';
import { Button } from '@/components/ui/button';

const SAMPLE_TEXT = `Rapid Serial Visual Presentation (RSVP) is a technique for displaying text in which words are presented one at a time at a specific location on the screen. This method eliminates eye movement and enables reading speeds of 300-1000 words per minute while maintaining comprehension. The key to effective RSVP is the Optimal Recognition Point (ORP), positioned at approximately 30-40% from the start of each word, which aligns with natural eye fixation patterns discovered through eye-tracking research.`;

export default function Home() {
  const [text, setText] = useState(SAMPLE_TEXT);
  const initialize = useReadingStore((state) => state.initialize);
  const reset = useReadingStore((state) => state.reset);
  const wordsPerGroup = useSettingsStore((state) => state.wordsPerGroup);

  const handleLoadText = () => {
    if (text.trim()) {
      const grouped = groupWords(text, wordsPerGroup);
      initialize(grouped);
    }
  };

  const handleReset = () => {
    reset();
    setText(SAMPLE_TEXT);
  };

  // Auto-load sample text on mount
  useEffect(() => {
    handleLoadText();
  }, []);

  return (
    <main className="min-h-screen p-8">
      <div className="max-w-6xl mx-auto space-y-8">
        {/* Header */}
        <div className="text-center space-y-2">
          <h1 className="text-4xl font-bold tracking-tight">
            RSVP Speed Reader
          </h1>
          <p className="text-muted-foreground">
            Read faster with precision focal point guidance
          </p>
        </div>

        {/* Main reading interface */}
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
          {/* Left column: RSVP Display and Controls */}
          <div className="lg:col-span-2 space-y-6">
            <RSVPDisplay />
            <div className="flex justify-center">
              <RSVPControls />
            </div>
          </div>

          {/* Right column: Settings */}
          <div>
            <SettingsPanel />
          </div>
        </div>

        {/* Text input section */}
        <Card>
          <CardHeader>
            <CardTitle>Load Text</CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            <Textarea
              value={text}
              onChange={(e) => setText(e.target.value)}
              placeholder="Paste your text here..."
              className="min-h-[150px] font-mono text-sm"
            />
            <div className="flex gap-2">
              <Button onClick={handleLoadText}>
                Load Text
              </Button>
              <Button onClick={handleReset} variant="outline">
                Reset to Sample
              </Button>
            </div>
          </CardContent>
        </Card>
      </div>
    </main>
  );
}
```

**Key aspects:**
- Sample text demonstrates RSVP concepts (self-describing)
- Text input allows user to test with custom text
- Auto-loads sample on mount for immediate demo
- Grid layout: RSVP display + controls (left), settings (right)
- Load button re-groups words when wordsPerGroup changes
- Reset button restores sample text

Need to install shadcn Textarea:
```bash
npx shadcn@latest add textarea
```

**Important:** Remove any old PDF viewer demo code from Phase 01-02. This is now pure RSVP reading interface.
  </action>
  <verify>
```bash
cat app/page.tsx | grep "RSVPDisplay"
cat app/page.tsx | grep "groupWords"
ls components/ui/textarea.tsx
npm run build
npm run dev
```

Start dev server and verify:
1. Sample text loads automatically
2. Play button starts reading
3. Words display with red center letter
4. Sliders adjust WPM and grouping
5. No console errors
  </verify>
  <done>app/page.tsx integrates RSVP components with sample text, dev server runs, UI functional</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete RSVP reading interface with:
- RAF-based timing engine displaying words at precise intervals
- ORP calculation highlighting center letter at 30-40% position
- Play/pause controls with visual state indication
- WPM slider (100-1000) for speed adjustment
- Word grouping slider (1-5) for display customization
- Live reading with sample text about RSVP technique
  </what-built>

  <how-to-verify>
**1. Start dev server:**
```bash
npm run dev
```
Open http://localhost:3000

**2. Verify ORP highlighting:**
- Sample text loads automatically
- Press "Play" button
- Watch words display at screen center
- Verify center letter is highlighted in RED
- For word "Rapid" → center should be "p" (not "p" at 50%)
- For word "the" → center should be "h" (second letter)
- For word "RSVP" → center should be "S" (30-40% position)

**3. Verify timing precision:**
- Default 300 WPM should feel smooth and consistent
- Increase to 600 WPM → should remain smooth without drift
- Pause mid-reading → press Play → should resume from exact position
- No word skipping or repeating

**4. Verify controls:**
- Play button starts reading, changes to "Pause"
- Pause button stops reading, changes to "Play"
- Progress counter increments (Word X of Y)
- Progress percentage accurate

**5. Verify settings:**
- Move WPM slider → reading speed changes immediately
- Move to 100 WPM → very slow (comfortable to verify ORP position)
- Move to 1000 WPM → very fast but no frame drops
- Change "Words Per Flash" slider → display changes
- Set to 2 words → see two words with ORP on first word
- Set to 5 words → see five words with ORP on first word

**6. Verify persistence:**
- Adjust WPM to 500
- Adjust Words Per Flash to 3
- Refresh browser (Cmd+R / Ctrl+R)
- Settings should persist (still 500 WPM, 3 words)

**7. Verify custom text:**
- Scroll to "Load Text" section
- Paste new text: "The quick brown fox jumps over the lazy dog"
- Click "Load Text"
- Press Play
- Should read custom text with ORP highlighting

**8. Test edge cases:**
- Reset to Sample button → restores original text
- Empty text area → Load button should handle gracefully
- Single word → should display correctly
- Very long word "extraordinarily" → ORP should be ~30% (letter "a")

**Expected behavior:**
✓ Words display centered with monospace font
✓ Center letter bold red with subtle glow
✓ Prefix/suffix dimmed (70% opacity)
✓ Smooth animation at all WPM settings
✓ No layout shift during reading
✓ Settings persist across refresh
✓ Controls respond immediately
  </how-to-verify>

  <resume-signal>
Type "approved" to continue, or describe any issues found:
- ORP calculation issues (wrong letter highlighted)
- Timing drift (words skip or repeat)
- Performance issues (frame drops at high WPM)
- Settings not persisting
- UI layout problems
  </resume-signal>
</task>

</tasks>

<verification>
**Component existence:**
```bash
ls -la components/reader/
ls -la components/ui/slider.tsx components/ui/label.tsx components/ui/textarea.tsx
```

**Build verification:**
```bash
npm run build
```

**Runtime verification:**
```bash
npm run dev
# Open http://localhost:3000
# Verify RSVP reading works with sample text
```

**Integration checks:**
```bash
# RSVPDisplay uses engine
grep "RSVPEngine" components/reader/RSVPDisplay.tsx

# ORP highlighting present
grep "splitAtORP" components/reader/RSVPDisplay.tsx

# Selective subscriptions
grep "useReadingStore.*=>.*\\." components/reader/RSVPDisplay.tsx

# Settings persist
grep "persist" store/settings-store.ts
```
</verification>

<success_criteria>
**Must be TRUE:**
1. ✓ User sees words at screen center with ORP-highlighted center letter
2. ✓ User can play/pause reading
3. ✓ User can adjust WPM (100-1000) during reading
4. ✓ User can adjust word grouping (1-5) during reading
5. ✓ Display maintains 60fps at all WPM settings
6. ✓ Settings persist across browser refresh
7. ✓ Sample text auto-loads on page mount
8. ✓ Custom text input works correctly

**Requirements satisfied:**
- RSVP-01: Words displayed in groups at center ✓
- RSVP-02: Center letter highlighted ✓
- RSVP-03: Customizable word group size ✓
- RSVP-04: Adjustable speed before reading ✓
- RSVP-05: Adjustable speed mid-reading ✓
- RSVP-06: Adjustable grouping mid-reading ✓
- RSVP-07: RAF-based timing ✓
- RSVP-08: ORP calculation ✓
- UI-01: Settings panel ✓
- UI-02: Minimalist shadcn design ✓
</success_criteria>

<output>
After human verification approval, create `.planning/phases/02-core-rsvp-engine/02-02-SUMMARY.md` documenting:
- RSVP display with ORP highlighting working
- RAF timing engine providing smooth 60fps display
- Play/pause controls functional
- WPM and word grouping adjustments working live
- Settings persistence verified
- All Phase 2 requirements satisfied
- Ready for Phase 3 (PDF Integration)
</output>
