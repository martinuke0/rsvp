---
phase: 03-pdf-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/pdf/pdf-extraction-worker.ts
  - lib/pdf/pdf-processor.ts
  - types/pdf-worker.ts
  - components/pdf/PDFUpload.tsx
  - components/ui/progress.tsx
autonomous: true

must_haves:
  truths:
    - "User can drag-and-drop PDF files up to 50MB onto upload area"
    - "UI remains responsive during PDF processing"
    - "User sees progress percentage while PDF is being processed"
  artifacts:
    - path: "lib/pdf/pdf-extraction-worker.ts"
      provides: "Web Worker that extracts text from PDF without blocking main thread"
      min_lines: 100
    - path: "lib/pdf/pdf-processor.ts"
      provides: "Main thread coordinator managing worker lifecycle and results"
      min_lines: 80
    - path: "types/pdf-worker.ts"
      provides: "TypeScript interfaces for worker message protocol"
      min_lines: 30
    - path: "components/pdf/PDFUpload.tsx"
      provides: "Upload component with drag-and-drop and progress display"
      min_lines: 100
  key_links:
    - from: "components/pdf/PDFUpload.tsx"
      to: "lib/pdf/pdf-processor.ts"
      via: "instantiate PDFProcessor and call extractText"
      pattern: "new PDFProcessor.*extractText"
    - from: "lib/pdf/pdf-processor.ts"
      to: "lib/pdf/pdf-extraction-worker.ts"
      via: "create worker with URL-based import"
      pattern: "new Worker\\(new URL.*pdf-extraction-worker"
    - from: "lib/pdf/pdf-processor.ts"
      to: "lib/pdf/pdf-extraction-worker.ts"
      via: "transfer ArrayBuffer via postMessage"
      pattern: "postMessage.*\\[buffer\\]"
---

<objective>
Establish non-blocking PDF processing infrastructure with Web Worker architecture for files up to 50MB.

Purpose: Create foundational architecture that cannot be retrofitted later. Web Workers enable UI responsiveness during extraction (PERF-03) and handle large files without browser crashes. This architecture will be extended in subsequent plans for text extraction and TOC navigation.

Output: Working upload component that accepts PDFs, transfers them to worker thread, and reports progress back to main thread without UI blocking.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/03-pdf-integration/03-RESEARCH.md

# Prior work providing foundation
@.planning/phases/01-project-foundation/01-02-SUMMARY.md
@.planning/phases/02-core-rsvp-engine/02-01-SUMMARY.md

# Existing files to understand integration points
@lib/pdf-config.ts
@components/pdf/PDFViewer.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create worker message protocol types</name>
  <files>types/pdf-worker.ts</files>
  <action>
Create TypeScript interfaces for worker communication protocol:

**PDFExtractionResult interface:**
- text: string (full extracted text)
- outline: TOCItem[] (table of contents, initially empty array for this plan)
- pageCount: number
- filename: string

**TOCItem interface (stub for Plan 03-03):**
- title: string
- pageIndex: number
- level: number

**WorkerRequest union type (messages TO worker):**
- { type: 'extract', buffer: ArrayBuffer, filename: string }
- { type: 'cancel' }

**WorkerResponse union type (messages FROM worker):**
- { type: 'progress', progress: number }
- { type: 'complete', result: PDFExtractionResult }
- { type: 'error', error: string }

Export all types. Use discriminated unions for type safety.
  </action>
  <verify>npm run build completes without TypeScript errors</verify>
  <done>types/pdf-worker.ts exists with exported interfaces matching research pattern</done>
</task>

<task type="auto">
  <name>Task 2: Create PDF extraction worker</name>
  <files>lib/pdf/pdf-extraction-worker.ts</files>
  <action>
Create Web Worker that orchestrates PDF.js for text extraction:

**Import and configure PDF.js:**
```typescript
import * as pdfjsLib from 'pdfjs-dist';
pdfjsLib.GlobalWorkerOptions.workerSrc = '/pdf.worker.min.mjs';
```

**Message handler:**
- Listen for 'extract' messages with ArrayBuffer and filename
- Use pdfjsLib.getDocument({ data: buffer }) to load PDF
- For this plan: Extract ONLY page count (await pdf.numPages)
- Return minimal result: { text: '', outline: [], pageCount, filename }
- Report 100% progress immediately after loading
- Handle errors and send error response

**Why minimal extraction:** This plan focuses on worker infrastructure. Full text extraction with lazy page loading will be implemented in Plan 03-02 to keep tasks focused and testable.

Use transferable objects pattern from research (ArrayBuffer transfer). Follow error handling pattern with try-catch and structured error messages.
  </action>
  <verify>TypeScript compilation passes, worker file can be imported via new URL(..., import.meta.url)</verify>
  <done>Worker responds to 'extract' message and returns page count without errors</done>
</task>

<task type="auto">
  <name>Task 3: Create PDF processor class</name>
  <files>lib/pdf/pdf-processor.ts</files>
  <action>
Create main thread coordinator for worker lifecycle management:

**PDFProcessor class with:**
- private worker: Worker | null = null
- private onProgress?: (progress: number) => void callback
- constructor accepting optional { onProgress } config

**extractText method:**
- Validate file size â‰¤ 50MB (throw error if exceeded)
- Validate file type includes 'pdf' (throw error otherwise)
- Create worker using: new Worker(new URL('./pdf-extraction-worker.ts', import.meta.url))
- Return Promise<PDFExtractionResult>
- Set up message handlers for 'progress', 'complete', 'error' responses
- Implement 30s timeout with cleanup
- Transfer ArrayBuffer to worker: postMessage({ type: 'extract', buffer, filename }, [buffer])
- Call onProgress callback when progress messages received

**cancel method:**
- Send 'cancel' message to worker
- Call cleanup()

**private cleanup method:**
- Terminate worker
- Set worker to null

Follow error handling pattern from research with timeout, onerror, and structured Promise rejection. Use type imports from types/pdf-worker.ts.
  </action>
  <verify>npm run build passes, PDFProcessor can be instantiated and extractText called</verify>
  <done>PDFProcessor class exists with extractText returning Promise, cleanup on completion</done>
</task>

<task type="auto">
  <name>Task 4: Create shadcn Progress component</name>
  <files>components/ui/progress.tsx</files>
  <action>
Install and verify shadcn Progress component:

```bash
npx shadcn@latest add progress
```

Verify installation creates components/ui/progress.tsx with Radix UI Progress primitive styled with Stone theme. No modifications needed - shadcn handles Stone theme integration automatically.
  </action>
  <verify>components/ui/progress.tsx exists and exports Progress component</verify>
  <done>shadcn Progress component installed and ready for use in upload UI</done>
</task>

<task type="auto">
  <name>Task 5: Create PDF upload component</name>
  <files>components/pdf/PDFUpload.tsx</files>
  <action>
Create upload component with drag-and-drop and progress display:

**Component structure:**
- "use client" directive at top
- Accept onUploadComplete: (result: PDFExtractionResult) => void prop
- State: isUploading (boolean), progress (number), error (string | null)

**Drag-and-drop:**
- Use Card component from shadcn for drop zone
- onDragOver: preventDefault + visual indication (border highlight)
- onDrop: preventDefault, extract first file from dataTransfer
- onClick: trigger hidden file input (accept=".pdf")

**File processing:**
- Instantiate PDFProcessor with onProgress callback updating state
- Call processor.extractText(file)
- On success: call onUploadComplete(result)
- On error: set error state with message
- Use try-finally to reset isUploading state

**UI states:**
- Idle: "Drag and drop PDF here or click to browse" with Upload icon
- Uploading: Progress component showing percentage + "Processing PDF..." text
- Error: Error message in red with retry button

**Styling:**
- Use Stone theme Card with dashed border for drop zone
- Center all content vertically and horizontally
- Show lucide-react Upload icon when idle
- Use Progress component from Task 4 when uploading

Import types from types/pdf-worker.ts. Follow research React integration pattern with useState for local UI state.
  </action>
  <verify>npm run build passes, component renders without errors, accepts PDF files</verify>
  <done>PDFUpload component accepts PDFs, shows progress, calls onUploadComplete callback</done>
</task>

</tasks>

<verification>
**Build verification:**
```bash
npm run build
```
Must complete without errors.

**Type safety verification:**
```bash
npx tsc --noEmit
```
Must pass with no type errors.

**Worker creation verification:**
Check that worker is created with URL-based import (webpack 5 syntax):
```bash
grep -r "new Worker(new URL" lib/pdf/
```
Must find pattern in pdf-processor.ts

**File size validation:**
Create 51MB dummy file and verify error handling:
```bash
dd if=/dev/zero of=/tmp/large.pdf bs=1m count=51
```
Upload should reject with "exceeds 50MB limit" error.
</verification>

<success_criteria>
**Measurable completion criteria:**

1. **Worker infrastructure functional:**
   - Worker file compiles and can be instantiated
   - Message protocol types match research pattern
   - PDFProcessor manages worker lifecycle correctly

2. **Upload component operational:**
   - Drag-and-drop accepts PDF files
   - Progress updates display during processing
   - File size validation rejects files >50MB
   - Error states display clearly

3. **Non-blocking processing:**
   - UI remains responsive during PDF loading
   - Progress updates without janking
   - Worker cleanup happens on completion/error

4. **Production-ready:**
   - TypeScript compilation passes
   - Build succeeds without warnings
   - Worker loads correctly (no 404 errors in dev tools)
   - Component follows established patterns (shadcn, Stone theme)

**Pass criteria:** User can upload PDF, see progress bar, and receive result callback without UI freezing.
</success_criteria>

<output>
After completion, create `.planning/phases/03-pdf-integration/03-01-SUMMARY.md` following established summary format with frontmatter (phase, plan, subsystem: pdf, tags, dependency graph, tech tracking, key-files, key-decisions, patterns-established, metrics).
</output>
