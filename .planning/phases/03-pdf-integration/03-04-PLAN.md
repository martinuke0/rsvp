---
phase: 03-pdf-integration
plan: 04
type: execute
wave: 4
depends_on: [03-03]
files_modified:
  - components/pdf/TOCNavigation.tsx
  - components/pdf/PageRangeSelector.tsx
  - app/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can see extracted table of contents when PDF has structured outline"
    - "User can navigate to specific sections via TOC"
    - "User can manually select page range when PDF lacks TOC"
    - "User can return to document navigation after reading session"
  artifacts:
    - path: "components/pdf/TOCNavigation.tsx"
      provides: "Hierarchical TOC display with clickable navigation"
      min_lines: 80
    - path: "components/pdf/PageRangeSelector.tsx"
      provides: "Manual page range selection UI"
      min_lines: 60
    - path: "app/page.tsx"
      provides: "Integrated navigation view with TOC and page selector"
      contains: "TOCNavigation"
  key_links:
    - from: "components/pdf/TOCNavigation.tsx"
      to: "store/document-store.ts"
      via: "read TOC items and selected section"
      pattern: "useDocumentStore.*outline"
    - from: "components/pdf/TOCNavigation.tsx"
      to: "lib/pdf/section-extractor.ts"
      via: "extract text for selected TOC section"
      pattern: "extractSectionText"
    - from: "lib/pdf/section-extractor.ts"
      to: "store/reading-store.ts"
      via: "initialize RSVP with selected section text"
      pattern: "readingStore.*initialize"
    - from: "app/page.tsx"
      to: "store/document-store.ts"
      via: "wire upload handler to store extracted data"
      pattern: "setDocument"
---

<objective>
Build navigation UI components enabling users to browse and select PDF sections for RSVP reading.

Purpose: Fulfill requirements PDF-03 (extract TOC), PDF-04 (manual page range), PDF-05 (navigate sections), PDF-06 (return to TOC). Long PDFs need structured navigation - users shouldn't read entire document sequentially. UI provides both automatic (TOC) and manual (page range) navigation methods.

Output: Document navigation view showing TOC hierarchy or page range selector, section selection triggering RSVP reading, and back navigation preserving document state.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/03-pdf-integration/03-RESEARCH.md

# Prior plans establishing extraction and data layer
@.planning/phases/03-pdf-integration/03-01-SUMMARY.md
@.planning/phases/03-pdf-integration/03-02-SUMMARY.md
@.planning/phases/03-pdf-integration/03-03-SUMMARY.md

# Existing stores and utilities created in Plan 03-03
@store/document-store.ts
@lib/pdf/section-extractor.ts
@store/reading-store.ts
@store/settings-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TOC navigation component</name>
  <files>components/pdf/TOCNavigation.tsx</files>
  <action>
Create hierarchical TOC navigation UI:

**Component structure:**
- "use client" directive
- Props: onSectionSelect: (item: TOCItem) => void
- Read outline from useDocumentStore
- Display hierarchical list of TOC items

**UI layout:**
- Use Card component for container
- Title: "Table of Contents" with document filename
- If outline.length === 0: Show "No table of contents available" message with note to use page range selector
- If outline.length > 0: Render hierarchical list

**TOC item rendering:**
- Map over outline items
- Indentation based on item.level (0 = no indent, 1 = 1rem, 2 = 2rem, etc.)
- Clickable button/link with item.title and page number
- onClick: call onSectionSelect(item)
- Hover state with Stone theme accent color
- Current section highlighted (compare with document store current section)

**Styling:**
- Use Stone theme colors for consistency
- Hierarchical indentation using padding-left
- Truncate long titles with ellipsis
- Show page numbers in muted color on right side
- Scrollable list if many items (max-height with overflow-y-auto)

Follow shadcn component patterns. Use lucide-react icons (BookOpen for title, ChevronRight for items).
  </action>
  <verify>Component renders with sample TOC data, items are clickable</verify>
  <done>TOCNavigation displays hierarchical TOC and triggers section selection callback</done>
</task>

<task type="auto">
  <name>Task 2: Create page range selector component</name>
  <files>components/pdf/PageRangeSelector.tsx</files>
  <action>
Create manual page range selection UI for PDFs without TOC:

**Component structure:**
- "use client" directive
- Props: pageCount: number, onRangeSelect: (start: number, end: number) => void
- State: startPage (number), endPage (number), error (string | null)

**UI layout:**
- Use Card component for container
- Title: "Select Page Range"
- Two Input fields (shadcn input component):
  - "From page" (1 to pageCount)
  - "To page" (1 to pageCount)
- Button: "Load Section" (calls onRangeSelect)

**Validation:**
- startPage must be ≥ 1 and ≤ pageCount
- endPage must be ≥ startPage and ≤ pageCount
- Show error message if validation fails
- Disable button until valid range entered

**Default values:**
- startPage = 1
- endPage = Math.min(10, pageCount) (first 10 pages or fewer)

**Styling:**
- Use Label components for input labels
- Stone theme form styling
- Error messages in red below inputs
- Compact layout (inputs side-by-side if space allows)

Install shadcn Input if not already available: `npx shadcn@latest add input`
  </action>
  <verify>Component renders, validates input, calls callback with valid range</verify>
  <done>PageRangeSelector accepts page range input and triggers selection callback</done>
</task>

<task type="auto">
  <name>Task 3: Integrate document store wiring in upload handler</name>
  <files>app/page.tsx</files>
  <action>
Integrate document store to receive extracted PDF data from upload handler:

**Verify existing wiring from Plan 03-02 Task 3:**
In the PDF upload completion handler, ensure this pattern exists:
```typescript
import { useDocumentStore } from '@/store/document-store';

// After extraction completes
const result = await processor.extractText(file);

// Store extracted data
useDocumentStore.getState().setDocument(
  result.filename,
  result.pageCount,
  result.text,
  result.outline
);
```

This should already be implemented in Plan 03-02 Task 3. If missing, add it now.

**Why this task:** Checker identified that document store wiring might be missing. This task verifies the connection exists between extraction (03-02) and navigation (03-03).

No additional changes needed if wiring already present from Plan 03-02.
  </action>
  <verify>Document store receives PDF data after upload, outline field populated</verify>
  <done>Upload handler stores extraction result in document store for navigation use</done>
</task>

<task type="auto">
  <name>Task 4: Add navigation view UI</name>
  <files>app/page.tsx</files>
  <action>
Add document navigation view between upload and reading:

**Add imports:**
```typescript
import { TOCNavigation } from '@/components/pdf/TOCNavigation';
import { PageRangeSelector } from '@/components/pdf/PageRangeSelector';
import { useDocumentStore } from '@/store/document-store';
import { extractSectionText } from '@/lib/pdf/section-extractor';
```

**Add view state:**
```typescript
const [view, setView] = useState<'upload' | 'navigation' | 'reading'>('upload');
```

**Update PDF upload completion handler:**
After extraction completes and document store is populated:
```typescript
// Show navigation view
setView('navigation');
```

**Navigation view rendering:**
When view === 'navigation', show:
1. Document info header (filename, page count)
2. If outline.length > 0: TOCNavigation component
3. If outline.length === 0 OR user toggles: PageRangeSelector component
4. "Start Reading Full Document" button (bypasses section selection)

**Section selection handlers:**

**TOC item click:**
```typescript
const handleTOCSelect = (item: TOCItem) => {
  const doc = useDocumentStore.getState();
  // Navigate to section (current item to next item or end)
  const nextItem = outline[outline.indexOf(item) + 1];
  const endPage = nextItem ? nextItem.pageIndex : doc.pageCount;

  const sectionText = extractSectionText(
    doc.fullText,
    item.pageIndex + 1, // pageIndex is 0-based
    endPage,
    doc.pageCount
  );

  // Initialize RSVP with section text
  const groupedWords = groupWords(sectionText, wordsPerGroup);
  useReadingStore.getState().initialize(groupedWords);

  // Store section info
  doc.setSection(item.pageIndex + 1, endPage);

  setView('reading');
};
```

**Page range submit:**
```typescript
const handleRangeSelect = (start: number, end: number) => {
  const doc = useDocumentStore.getState();
  const sectionText = extractSectionText(doc.fullText, start, end, doc.pageCount);

  const groupedWords = groupWords(sectionText, wordsPerGroup);
  useReadingStore.getState().initialize(groupedWords);

  doc.setSection(start, end);

  setView('reading');
};
```

**Full document:**
```typescript
const handleFullDocument = () => {
  const doc = useDocumentStore.getState();
  const groupedWords = groupWords(doc.fullText, wordsPerGroup);
  useReadingStore.getState().initialize(groupedWords);

  doc.setSection(1, doc.pageCount);

  setView('reading');
};
```

Maintain existing manual text input option alongside PDF workflow. View state management keeps flows independent.
  </action>
  <verify>Navigation view displays after upload, TOC items and page range selector work</verify>
  <done>User sees navigation view after PDF upload with TOC or page range options</done>
</task>

<task type="auto">
  <name>Task 5: Add back navigation button</name>
  <files>app/page.tsx</files>
  <action>
Add "Back to Navigation" button in reading view for PDF navigation:

**In reading view (view === 'reading'), add button:**
- Position: Above or below RSVP controls
- Text: "← Back to Navigation"
- Styling: Secondary button style (Stone theme)
- Show only when: document store has a loaded document

**onClick handler:**
```typescript
const handleBackToNavigation = () => {
  const doc = useDocumentStore.getState();

  if (doc.filename) {
    // Pause RSVP playback (preserve current position)
    useReadingStore.getState().pause();

    // Return to navigation view (document state preserved)
    setView('navigation');
  }
};
```

**Reading position preservation (PDF-06 requirement):**
Decision: When user navigates back to TOC, preserve RSVP position within current section.
- On back: Call pause() to stop playback, keep current word index
- If user selects same section again: Resume from preserved position (existing behavior)
- If user selects different section: Reset to beginning of new section (initialize() resets position)

This approach balances requirement PDF-06 (return to TOC) with usability - users can resume where they left off if returning to same section.

**Styling:**
- Use Button component from shadcn
- Place in Card above/below controls
- Add lucide-react ArrowLeft icon
- Muted/secondary appearance (not primary action)

Only show for PDF documents (check if document store has filename). Manual text input flow doesn't need navigation.
  </action>
  <verify>npm run dev, upload PDF, navigate to section, verify back button returns to navigation, RSVP pauses</verify>
  <done>Back button returns user to navigation view, preserves document state, pauses RSVP playback</done>
</task>

</tasks>

<verification>
**Navigation flow test:**
```bash
npm run dev
```

1. Upload PDF with TOC (10+ sections)
2. Verify TOC displays hierarchically
3. Click TOC item #2
4. Verify RSVP displays section text only (check text length in store matches expected range)
5. Click "Back to Navigation"
6. Verify returns to TOC view
7. Select different section (item #5)
8. Verify RSVP updates with new section text

**Manual page range test:**
1. Upload PDF without TOC
2. Verify PageRangeSelector displays
3. Enter range: pages 5-10
4. Click Load Section
5. Verify RSVP displays text from those pages
6. Test validation: enter invalid ranges (start > end, page > pageCount)
7. Verify error messages display

**Back navigation test:**
1. Upload PDF with TOC
2. Navigate to section
3. Start RSVP playback
4. Click "Back to Navigation"
5. Verify playback pauses
6. Verify returns to navigation view
7. Select same section
8. Verify reading position preserved

**Build verification:**
```bash
npm run build
npx tsc --noEmit
```
Both must pass without errors.
</verification>

<success_criteria>
**Measurable completion criteria:**

1. **Navigation UI operational:**
   - TOC displays hierarchically with proper indentation
   - TOC items clickable and trigger section load
   - Page range selector validates input
   - Both flows lead to RSVP reading of selected content

2. **Section reading works:**
   - Clicking TOC item loads section text into RSVP
   - Manual page range loads specified pages
   - Reading controls work with section text
   - Back button returns to navigation without losing document state

3. **User experience smooth:**
   - Clear visual distinction between upload, navigation, and reading views
   - Can switch between TOC and page range selection
   - Full document reading remains available as option
   - Navigation state persists during reading session

4. **Production-ready:**
   - TypeScript compilation passes
   - Build succeeds without warnings
   - All components follow shadcn patterns
   - Stone theme styling consistent throughout
   - No console errors in browser DevTools

**Pass criteria:** User uploads PDF, sees TOC or page selector, navigates to specific section, reads with RSVP, and can return to select different section.
</success_criteria>

<output>
After completion, create `.planning/phases/03-pdf-integration/03-04-SUMMARY.md` following established summary format with frontmatter (phase, plan, subsystem: pdf-navigation, tags, dependency graph, tech tracking, key-files, key-decisions, patterns-established, metrics).
</output>
